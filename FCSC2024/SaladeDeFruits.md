---
# Salade de fruits

| Chal info | FCSC2024 |
| ------ | ----------- |
| Name | Salade de fruits |
| Category   | Crypto |
| Difficulty | :star: :star: |
| Number of solves | ? |
| Type | Diophantine Equation - Elliptic Curve |
| Writeup by | htmb |

Below is the challenge code, nice and short.

``` py
from itertools import count
from hashlib import sha256

for pineapple in count(start = 1):
  for strawberry in range(1, pineapple + 1):
    for banana in range(1, pineapple + 1):
      if pineapple ** 3 + strawberry ** 3 == 94 * banana ** 3:
        h = sha256(str(banana).encode()).hexdigest()
        print(f"FCSC{{{h}}}")
        exit(1)
```

So we need to find the smallest solution to the equation $a^3+b^3=94c^3$ with positive integers. That looks fun!

This is an Elliptic Curve. If I can convert it to Weierstrass form then hopefully pari can find its rational generators for me and then I will be able to derive the smallest solution.

I use [Approach Zero](https://approach0.xyz/search/) with equation $a^3+b^3=dc^3$ and keyword "Elliptic Curve" to see if anyone has derived the birational transformation for me. Indeed I'm in luck as this seems to be related to "Selmer Curves" (cultural: the name seems to originate from Selmerâ€™s cubic $3x^3 + 4y^3 + 5z^3$, which is a famous example of an irreducible polynomial that has no nontrivial rational zero, but that has a nontrivial real and $p$-adic zero for all $p$.). Let's focus on [this stackexchange thread](https://math.stackexchange.com/questions/2529155/isomorphism-via-birational-equivalence?noredirect=1) that was returned by the search engine.

By inverting the isomorphism (and fixing typos in the post), I now know that if $(x,y,z)$ is a solution of $`x^3=y^2z - 432d^2z^3`$, then $`(a,b,c)=(y - 36dz, -y - 36dz, -6x)`$ is a solution of $`a^3+b^3=dc^3`$.

So we are left to study a curve that can be defined in SageMath as `E = EllipticCurve([0,-432*d^2])`. The structure of $E$ over $\mathbb{Q}$ is given by the Mordell-Weil theorem, that essentially affirms that the group of rational points of $E$ is finitely generated and can hence be written

```math
E(\mathbb{Q}) \simeq E(\mathbb{Q})_{tors} \oplus \mathbb{Z}^r,
```

where $`E(\mathbb{Q})_{tors}`$ refers to torsion points (points that can be added to themselves to give $0$) and $`r\in \mathbb{Z}_{\ge 0}`$ is the **rank** of the elliptic curve $E$. Using pari's `elltors()` and `ellrank()` functions, we get all the information we need. Using the SageMath interface to pari: 

```py
d = 94
E = EllipticCurve([0,-432*d^2])

E_tors = pari.elltors(E)
print("Pari output for torsion:",E_tors)

E_rank = pari.ellrank(E)
print("Pari output for rank:",E_rank)
```

```
Pari output for torsion: [1, [], []]
Pari output for rank: [1, 1, 0, [[62511752209/2480625, 15629405421521177/3906984375]]]

```

For $d=94$, $E$ is torsion-free, and $r=1$. This means that $`E(\mathbb{Q})=\langle G \rangle_{\mathbb{Z}}`$, where $G$ is a rational generator. As a bonus, `ellrank()` has already given us $G=(62511752209/2480625:15629405421521177/3906984375:1)$. 

Now the process is straightforward, we convert $G$'s coordinates via the rational isomorphism to get a rational solution for our initial equation and multiply by the common denominator to get an integral solution. By then, we should be concerned about two things:
- are all three integers positive?
- is this triplet the minimal solution?

For the first question, it is enough that the integers have the same sign, but if two differ in sign, then we don't have a valid solution. By our previous discussion on the rank, we know that all rational points on the curve are obtained by birational transformation of a multiple of $G$. We also know that the equation has a valid solution in positive integers otherwise the challenge would be impossible, therefore we can try other multiples of $G$ (we only care about positive multiples as negative multiples only change the signs).

For the second question, this is slightly more involved, and a rigorous proof can be obtained by introducing the concept of *heights*. This is a CTF challenge and not a maths dissertation, so the only proof I will give is an accepted flag. Indeed, it is quite clear from looking at coordinates of multiples of $G$ that they grow, and they grow fast. So strating from $G$ and progressively adding $G$, the first multiple that we encounter that transforms to three integers of same sign should give the solution to the challenge.

Here is the full code, in SageMath.

```py
d = 94
E = EllipticCurve([0,-432*d^2])

E_rank = pari.ellrank(E)
assert E_rank[0] == E_rank[1] # rank has been found
assert E_rank[0] == 1 # rank is 1
assert pari.elltors(E)[0] == 1 # torsion is trivial
print("E has rank",E_rank[0])

G = E(E_rank[3][0][0], E_rank[3][0][1]) # Generator

def transfo(x,y,z,d): # Birational isomorphism
    a,b,c = y - 36*d*z, -y - 36*d*z, -6*x
    return a,b,c

Found = False
i = 0
while not Found:
    i += 1
    x,y,z = i*G # Point on E
    a,b,c = transfo(x,y,z,d) # Transform to rational solution 
    assert a**3+b**3 == d*c**3
    if(sign(a) == sign(b) and sign(b) == sign(c)):
        Found = True
        print("Found at i=",i)
        common_denom = lcm([a.denom(),b.denom(),c.denom()])
        A,B,C = sign(a)*a*common_denom, sign(a)*b*common_denom, sign(a)*c*common_denom # get integer solution from rational solution
        print("\nA=",A)
        print("\nB=",B)
        print("\nC=",C)

# Get flag

from hashlib import sha256
h = sha256(str(C).encode()).hexdigest()
print(f"\nFlag is FCSC{{{h}}}") # FLAGZ
```

This gives the following output:

```
E has rank 1
Found at i= 11

A= 722730855291655570648364472593373207301669838049128815802761555003158908543253757834189350276048574266183923889135513672633473584694081901380483327183472605986005893477598234010608532875471169750420689753187442309142141540669072675511172446418744039599418122283859332429195327691565961568113715598402411728408888182041019180214299384446721005644177762524261614733670609710306299627844060849966169695398318980200744035564604747773686799037662773743200849806460369368664514681958958027477957126929470650023248059150241071592923363906553836975177255615410880029757369894921463446538060162912454672181738883460531563471016097039810948230523264063602751576712338013809066911021712371791514206050165484611035527765162646989873801879018621381682249742626037276515916270313847223404355635361816812172273353834097669921058498420586771308931795540008459109778446094144175383372362004281964367892229490650216882924749425120152434832758028821842062339224782679736797735356704500011443682086767648233530001243751145522130024765624553613542788795754581791742436489619581871928399046728848504093078738408281811664097499867488308463303073753480076218684981885464841735452384061137076205274357932902465079699906008610902088834722210098687428808891893999087493036776637864564222212691611598981837538054793135524218888716422536668527434761357541273208518954456825030260690381762014955519980355711371787120232530300165587458379955613207547038597521942968262926934787384069284071783756022158583060963949517206151505243441873761869370357506659168176512097981140513863503036746399395984826941623261463791566763580767150876124797055371329828424430673982408327940686851033986711038811746337269665015778961886856113296245766355293607981333917080212181532904764400470316426171920265899604036487932759360360402325402273366581691372199109231273749220585342442785054661501181846698669892991508475833969933601317590044439109187196625919847750156853352373212068952397966943844278004644207423

B= 5838029425998642036519121386766237934443985371712628493866262802675611337745332163898432961240106270481701083644830663378675493757512360711588260537548344410361717772825990984832688854346492124099165831823104743551511236792247436196331973417983047967998588147284427165684321624144744763482111480138223123116789062981203069167757719302484743085332337963086108197977736185589403289931423637507107778287502927763625087383617218165325045803292348657514858771172134531042650131983986335338104219586684625893401220714474638519831965046743552916194004391766472139979796569194772427444065418854924655324074099085710733629720240324970327539888796898419928894549064951165988240377204917430163823613150689446507374954363006503625866185678870352642426810130325439462677497986496968756540651840100222679906509738322823556238901994223912013974297010154093142434697514104988355699415976770809936297195997499785647630578992294300430478317869106922160198824989765018210446193387652795657898763923856557233581181937666124912044317142384056579396851929319098997381629962563737880642242185348648252693616827951750783377991668333402660952105078632353664473113427365172657211603238218187336980036947879631581986949259800534182102622386811906071268082421777187401960852549631756341734866681812420745618318144789752428940082377377215609933418896605642204379296457459597922047486276069206283465101026874516372063869071587189597315184159364969951781913858172733676265962251269417894937843589334235462829077780907357771950210680441024778019267655776709594011393228717778066136780996042801316935666963007479467995437558075470510975344106938530350734753976272079327791857953686843109153157364180149064780289677452184201015747312000085265635971008610364740312047696850062179606954035059641243127937135957516916383417388753979889985842492345633183944959802210364669821354320916179436239943420934744102985618629995477553812458411574733978116203321324251962132347145347318440435288422058542577

C= 1284787770466747714214463308674513623822926372114908566468479478290930421154475905257855042608379517001345895836571922831019219960076589350494709967265234749739593440020425071515369858596573419172416921450292553675556200241364124372778378009407483220717623841656057014455872843067578444266191644173890107493561115462880829471903682697103710017275721258133575141386919729904952547572322880577697812560004096729511480191539876713447688218462013326864481518018980085439510020245603299796987787026747085068246942823483155176744176984940588090328219055261726881663762636064519564504530342638845828290148354407250458132172073751256948957492049546255729177214683016783611250043627056236160532218032551770132382409941214538875688889836254147167095679585095592933136757110517310929331115520731839126680436646840096258000192002957516677617442976797467214810171121101193424094289620379664018211608816183365917541288808799814022860741643966463653081179010980493172510299974966934123887257030154911221451270828480795653112311577071572889270495122430941642346728707912937712029923078926454526311867287560092941833856229882667302754302199642064236052165354325804530898689379390996818003875460560630973033843039733127758595531547058058685605627269981349800993306454972781056201486033523543726104638829295418452731011945348944226383300112907389544874605362315758175482045942424045175555053576214273219909652720360148138441970437684909762723167423625601562427925003482830522566935351037596166953501925896226538370435559220633718295971706728712339899286181647926751020146565992265117699419351479373739070693022307154341520480810492552207121603555460575535033719354032696081265468772433457335111989981309754715592647440894475862809326662955050205889059831968321107725463551633107019599799720777025772991803297749847052492559931491294312543895073996602048895989408887901610561953827815924021997585268776414663325796185115147042984696391503710578409567605819451537087627601685885550

Flag is FCSC{2c69e5056f2a80af36c0880a2395472e51b448730a1c5c06b2b0d8e0a3b466b6}
``` 

We get the flag. 

As a bonus, this method works for any $d$ such that the rank of $E$ is $1$. The solution for $d=94$ is the largest until $d = 752$, which might explain why $94$ was chosen.

I would like to thank the organisers of the CTF for this very fun challenge! 
